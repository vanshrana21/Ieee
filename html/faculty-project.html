<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View - Faculty | Juris AI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .read-only { background-color: #f9fafb; cursor: not-allowed; }
        .section-header { background: linear-gradient(to right, #1e40af, #3b82f6); }
        .irac-block { border-left: 4px solid #3b82f6; }
        .note-card { border-left: 4px solid #f59e0b; }
        .activity-item { border-bottom: 1px solid #e5e7eb; }
        .activity-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <a href="/faculty-dashboard.html" class="text-blue-200 hover:text-white text-sm mb-1 block">← Back to Dashboard</a>
                    <h1 id="project-title" class="text-2xl font-bold">Loading...</h1>
                </div>
                <div class="text-right">
                    <span id="project-status" class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Warning Banner -->
    <div class="bg-red-50 border-l-4 border-red-400 p-4">
        <div class="container mx-auto flex items-center">
            <svg class="h-5 w-5 text-red-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <p class="text-sm text-red-700">
                <strong>READ-ONLY MODE:</strong> You are viewing this project as Faculty. You cannot edit any content. 
                <span class="underline">This is for mentoring purposes only.</span>
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Progress Overview -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Progress Overview</h2>
                <div id="progress-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Progress metrics populated by JS -->
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Project Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- IRAC Section -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="section-header px-6 py-3 text-white">
                        <h3 class="text-lg font-semibold">IRAC Content (Read-Only)</h3>
                    </div>
                    <div id="irac-content" class="p-6">
                        <!-- IRAC content populated by JS -->
                    </div>
                </section>

                <!-- Issues Section -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="section-header px-6 py-3 text-white">
                        <h3 class="text-lg font-semibold">Issues</h3>
                    </div>
                    <div id="issues-content" class="p-6">
                        <!-- Issues populated by JS -->
                    </div>
                </section>

                <!-- Oral Rounds Section -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="section-header px-6 py-3 text-white">
                        <h3 class="text-lg font-semibold">Oral Rounds</h3>
                    </div>
                    <div id="oral-rounds-content" class="p-6">
                        <!-- Oral rounds populated by JS -->
                    </div>
                </section>

                <!-- Activity Log Section -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gray-800 px-6 py-3 text-white">
                        <h3 class="text-lg font-semibold">Activity Log</h3>
                    </div>
                    <div id="activity-content" class="p-6 max-h-96 overflow-y-auto">
                        <!-- Activity log populated by JS -->
                    </div>
                </section>
            </div>

            <!-- Right Column: Faculty Notes -->
            <div class="space-y-8">
                <!-- Add Note Card -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-amber-500 px-6 py-3 text-white">
                        <h3 class="text-lg font-semibold">Add Faculty Note</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-gray-600 mb-3">
                            Add advisory notes for mentoring. These are private to you and do not affect student work.
                        </p>
                        <textarea id="new-note-text" class="w-full border border-gray-300 rounded p-3 text-sm" rows="4" placeholder="Enter your advisory note here..."></textarea>
                        <button onclick="addNote()" class="mt-3 w-full bg-amber-500 text-white py-2 rounded hover:bg-amber-600 transition">
                            Add Note
                        </button>
                        <p class="text-xs text-gray-500 mt-2 italic">
                            Faculty Guidance (Non-Evaluative)
                        </p>
                    </div>
                </section>

                <!-- Existing Notes -->
                <section class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gray-100 px-6 py-3 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">Your Notes</h3>
                    </div>
                    <div id="notes-list" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                        <!-- Notes populated by JS -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Edit Note Modal -->
    <div id="edit-note-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Faculty Note</h3>
            <textarea id="edit-note-text" class="w-full border border-gray-300 rounded p-3 text-sm" rows="4"></textarea>
            <input type="hidden" id="edit-note-id">
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="saveNoteEdit()" class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let projectId = null;
        let projectData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');
            
            if (!projectId) {
                alert('No project ID provided');
                window.location.href = '/faculty-dashboard.html';
                return;
            }

            loadProjectDetails();
        });

        // Load Project Details
        async function loadProjectDetails() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/faculty/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Access denied. You can only view projects in your institution.');
                        window.location.href = '/faculty-dashboard.html';
                        return;
                    }
                    throw new Error('Failed to load project');
                }

                const data = await response.json();
                projectData = data;

                // Update header
                document.getElementById('project-title').textContent = data.project.title;
                const statusEl = document.getElementById('project-status');
                statusEl.textContent = data.project.is_locked ? 'LOCKED' : 'DRAFT';
                statusEl.className = `px-3 py-1 rounded-full text-sm font-medium ${
                    data.project.is_locked ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                }`;

                // Render progress
                renderProgress(data.progress);

                // Render IRAC
                renderIRAC(data.irac_summary);

                // Render Issues
                renderIssues(data.issues);

                // Render Oral Rounds
                renderOralRounds(data.oral_rounds);

                // Render Activity
                renderActivity(data.activity_logs);

                // Render Notes
                renderNotes(data.faculty_notes);

            } catch (error) {
                console.error('Project load error:', error);
                alert('Failed to load project details');
            }
        }

        // Render Progress
        function renderProgress(progress) {
            const container = document.getElementById('progress-metrics');
            container.innerHTML = `
                <div class="bg-blue-50 p-4 rounded">
                    <p class="text-sm text-gray-600">IRAC Completeness</p>
                    <p class="text-2xl font-bold ${progress.irac_completeness >= 75 ? 'text-green-600' : progress.irac_completeness >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                        ${progress.irac_completeness}%
                    </p>
                </div>
                <div class="bg-purple-50 p-4 rounded">
                    <p class="text-sm text-gray-600">Issues</p>
                    <p class="text-2xl font-bold text-purple-600">${progress.issues_completed}/${progress.issues_count}</p>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <p class="text-sm text-gray-600">Oral Rounds</p>
                    <p class="text-2xl font-bold text-green-600">${progress.oral_rounds_count}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600">Last Activity</p>
                    <p class="text-lg font-bold text-gray-700">
                        ${progress.last_activity ? new Date(progress.last_activity).toLocaleDateString() : 'Never'}
                    </p>
                </div>
            `;
        }

        // Render IRAC
        function renderIRAC(iracSummary) {
            const container = document.getElementById('irac-content');
            if (!iracSummary || Object.keys(iracSummary).length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No IRAC content available</p>';
                return;
            }

            // Load full IRAC content
            loadIRACContent();
        }

        async function loadIRACContent() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/faculty/projects/${projectId}/irac`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load IRAC');

                const data = await response.json();
                const container = document.getElementById('irac-content');

                if (!data.irac_data || data.irac_data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">No IRAC content available</p>';
                    return;
                }

                container.innerHTML = data.irac_data.map(issue => `
                    <div class="mb-6 irac-block pl-4 py-2">
                        <h4 class="font-semibold text-gray-800 mb-3">Issue ${issue.issue_id}</h4>
                        <div class="space-y-3">
                            ${issue.blocks.map(block => `
                                <div class="bg-gray-50 p-3 rounded">
                                    <p class="text-xs font-semibold text-blue-600 uppercase mb-1">${block.block_type}</p>
                                    <p class="text-sm text-gray-700 read-only p-2 bg-gray-100 rounded">${block.content || '(Empty)'}</p>
                                    <p class="text-xs text-gray-400 mt-1">Version ${block.version}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('IRAC load error:', error);
                document.getElementById('irac-content').innerHTML = '<p class="text-red-500">Failed to load IRAC content</p>';
            }
        }

        // Render Issues
        function renderIssues(issues) {
            const container = document.getElementById('issues-content');
            if (!issues || issues.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No issues defined</p>';
                return;
            }

            container.innerHTML = issues.map(issue => `
                <div class="border-b border-gray-200 py-3 last:border-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${issue.title || `Issue #${issue.issue_order}`}</h4>
                            <p class="text-sm text-gray-600 mt-1">${issue.description || 'No description'}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            issue.status === 'completed' ? 'bg-green-100 text-green-800' :
                            issue.status === 'partial' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">${issue.status || 'not_started'}</span>
                    </div>
                </div>
            `).join('');
        }

        // Render Oral Rounds
        function renderOralRounds(rounds) {
            const container = document.getElementById('oral-rounds-content');
            if (!rounds || rounds.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No oral rounds recorded</p>';
                return;
            }

            container.innerHTML = rounds.map(round => `
                <div class="border-b border-gray-200 py-3 last:border-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${round.stage ? round.stage.charAt(0).toUpperCase() + round.stage.slice(1) : 'Round'}</h4>
                            <p class="text-sm text-gray-600 mt-1">
                                Responses: ${round.response_count || 0} | 
                                Transcript: ${round.has_transcript ? '✓' : '✗'}
                            </p>
                        </div>
                        ${round.has_transcript ? `
                            <button onclick="viewTranscript(${round.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                                View Transcript
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // View Transcript
        async function viewTranscript(roundId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/faculty/projects/${projectId}/oral-rounds/${roundId}/transcript`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load transcript');

                const data = await response.json();
                
                // Create modal to display transcript
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                modal.innerHTML = `
                    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Oral Round Transcript</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="bg-gray-50 p-4 rounded whitespace-pre-wrap font-mono text-sm">
                            ${data.transcript.full_text || '(No transcript content)'}
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            <p>Stage: ${data.round_stage || 'Unknown'}</p>
                            <p>Generated: ${data.transcript.generated_at ? new Date(data.transcript.generated_at).toLocaleString() : 'Unknown'}</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

            } catch (error) {
                alert('Failed to load transcript');
            }
        }

        // Render Activity
        function renderActivity(logs) {
            const container = document.getElementById('activity-content');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No activity recorded</p>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="activity-item py-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${log.action_type}</p>
                            <p class="text-xs text-gray-500">${log.target_name || ''}</p>
                            ${log.actor ? `<p class="text-xs text-gray-400">by ${log.actor.full_name || 'Unknown'}</p>` : ''}
                        </div>
                        <span class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Render Notes
        function renderNotes(notes) {
            const container = document.getElementById('notes-list');
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-center py-4">No notes added yet</p>';
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="note-card bg-amber-50 p-4 rounded">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${note.note_text}</p>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-amber-200">
                        <span class="text-xs text-gray-500">${new Date(note.created_at).toLocaleString()}</span>
                        <div class="space-x-2">
                            <button onclick="editNote(${note.id}, '${encodeURIComponent(note.note_text)}')" class="text-xs text-amber-600 hover:text-amber-800">Edit</button>
                            <button onclick="deleteNote(${note.id})" class="text-xs text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add Note
        async function addNote() {
            const text = document.getElementById('new-note-text').value.trim();
            if (!text) {
                alert('Please enter a note');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/faculty/projects/${projectId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ note_text: text })
                });

                if (!response.ok) throw new Error('Failed to add note');

                const data = await response.json();
                document.getElementById('new-note-text').value = '';
                
                // Reload notes
                loadProjectDetails();
                alert('Note added successfully');

            } catch (error) {
                alert('Failed to add note');
            }
        }

        // Edit Note
        function editNote(noteId, encodedText) {
            const text = decodeURIComponent(encodedText);
            document.getElementById('edit-note-id').value = noteId;
            document.getElementById('edit-note-text').value = text;
            document.getElementById('edit-note-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-note-modal').classList.add('hidden');
        }

        async function saveNoteEdit() {
            const noteId = document.getElementById('edit-note-id').value;
            const text = document.getElementById('edit-note-text').value.trim();

            if (!text) {
                alert('Please enter note text');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/faculty/notes/${noteId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ note_text: text })
                });

                if (!response.ok) throw new Error('Failed to update note');

                closeEditModal();
                loadProjectDetails();
                alert('Note updated successfully');

            } catch (error) {
                alert('Failed to update note');
            }
        }

        // Delete Note
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/faculty/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to delete note');

                loadProjectDetails();
                alert('Note deleted successfully');

            } catch (error) {
                alert('Failed to delete note');
            }
        }
    </script>
</body>
</html>
