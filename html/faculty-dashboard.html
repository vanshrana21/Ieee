<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard - Juris AI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .status-draft { background-color: #fef3c7; color: #92400e; }
        .status-locked { background-color: #fee2e2; color: #991b1b; }
        .status-submitted { background-color: #d1fae5; color: #065f46; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Faculty Dashboard</h1>
                    <p class="text-blue-200 text-sm">Academic Monitoring & Mentoring (Read-Only)</p>
                </div>
                <div class="text-right">
                    <p id="faculty-name" class="font-medium">Loading...</p>
                    <p id="faculty-institution" class="text-sm text-blue-200">Loading...</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Warning Banner -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Faculty View:</strong> You can monitor student progress but cannot edit submissions, modify deadlines, or assign scores. 
                        <a href="#" class="font-medium underline" onclick="showGuidelines(); return false;">View Guidelines</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Institution Metrics -->
        <section id="metrics-section" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Institution Overview</h2>
            <div id="metrics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Metrics will be populated by JS -->
                <div class="bg-white p-6 rounded-lg shadow-md metric-card animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </section>

        <!-- Teams Section -->
        <section id="teams-section" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Teams</h2>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projects</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Members</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="teams-table" class="bg-white divide-y divide-gray-200">
                        <!-- Teams will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects-section" class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Projects</h2>
                <div class="flex space-x-2">
                    <select id="status-filter" class="border border-gray-300 rounded px-3 py-1 text-sm">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="submitted">Submitted</option>
                        <option value="locked">Locked</option>
                    </select>
                    <button onclick="loadProjects()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                        Refresh
                    </button>
                </div>
            </div>
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Projects will be populated by JS -->
            </div>
        </section>

        <!-- Recent Activity -->
        <section id="activity-section">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Recent Activity</h2>
            <div id="activity-list" class="bg-white rounded-lg shadow-md p-4">
                <!-- Activity will be populated by JS -->
            </div>
        </section>
    </main>

    <!-- Guidelines Modal -->
    <div id="guidelines-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Faculty Oversight Guidelines</h3>
                <div class="mt-2 px-7 py-3 text-sm text-gray-600 space-y-3">
                    <p><strong class="text-green-600">✓ You CAN:</strong></p>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>View all student projects and progress</li>
                        <li>Read IRAC content and oral transcripts</li>
                        <li>View activity logs for accountability</li>
                        <li>Add advisory notes for mentoring</li>
                        <li>Monitor team engagement</li>
                    </ul>
                    <p><strong class="text-red-600">✗ You CANNOT:</strong></p>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>Edit student work (IRAC, issues, oral responses)</li>
                        <li>Submit, lock, or unlock projects</li>
                        <li>Extend deadlines or modify competition settings</li>
                        <li>Score or evaluate submissions</li>
                        <li>Impersonate students or use AI on their behalf</li>
                    </ul>
                    <p class="mt-4 bg-blue-50 p-3 rounded">
                        <strong>Note:</strong> All faculty actions are logged for transparency. Your role is to mentor and guide, not to influence outcomes.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="closeGuidelines()" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        I Understand
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let facultyData = null;
        let teamsData = [];
        let projectsData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });

        // Load Dashboard Data
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/faculty/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const data = await response.json();
                facultyData = data.faculty;
                
                // Update header
                document.getElementById('faculty-name').textContent = facultyData.full_name || 'Faculty';
                document.getElementById('faculty-institution').textContent = `Institution #${facultyData.institution_id}`;

                // Render metrics
                renderMetrics(data.metrics);

                // Render teams
                renderTeams(data.teams);
                teamsData = data.teams;

                // Render activity
                renderActivity(data.recent_activity);

                // Load projects
                loadProjects();

            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('Failed to load dashboard. Please try again.');
            }
        }

        // Render Metrics
        function renderMetrics(metrics) {
            const container = document.getElementById('metrics-grid');
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md metric-card">
                    <p class="text-sm text-gray-500 mb-1">Total Projects</p>
                    <p class="text-3xl font-bold text-gray-800">${metrics.total_projects}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md metric-card">
                    <p class="text-sm text-gray-500 mb-1">Active Teams</p>
                    <p class="text-3xl font-bold text-blue-600">${metrics.active_teams}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md metric-card">
                    <p class="text-sm text-gray-500 mb-1">Avg IRAC Completeness</p>
                    <p class="text-3xl font-bold ${metrics.average_irac_completeness >= 75 ? 'text-green-600' : metrics.average_irac_completeness >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                        ${metrics.average_irac_completeness}%
                    </p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md metric-card">
                    <p class="text-sm text-gray-500 mb-1">Locked Projects</p>
                    <p class="text-3xl font-bold text-purple-600">${metrics.locked_projects}/${metrics.total_projects}</p>
                </div>
            `;
        }

        // Render Teams
        function renderTeams(teams) {
            const tbody = document.getElementById('teams-table');
            if (!teams || teams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No active teams found</td></tr>';
                return;
            }

            tbody.innerHTML = teams.map(team => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${team.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${team.side === 'petitioner' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
                            ${team.side ? team.side.charAt(0).toUpperCase() + team.side.slice(1) : 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${team.project_count}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${team.member_count}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewTeamProjects(${team.id})" class="text-blue-600 hover:text-blue-900 mr-3">View Projects</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load Projects
        async function loadProjects() {
            try {
                const token = localStorage.getItem('access_token');
                const statusFilter = document.getElementById('status-filter').value;
                
                let url = `${API_BASE}/faculty/projects`;
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load projects');

                const data = await response.json();
                projectsData = data.projects;
                renderProjects(projectsData);

            } catch (error) {
                console.error('Projects load error:', error);
                showError('Failed to load projects');
            }
        }

        // Render Projects
        function renderProjects(projects) {
            const container = document.getElementById('projects-grid');
            if (!projects || projects.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No projects found</div>';
                return;
            }

            container.innerHTML = projects.map(project => `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${project.project_title}</h3>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(project.submission_status)}">
                            ${project.submission_status}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <p>Team ID: ${project.team_id}</p>
                        <p>IRAC: ${project.irac_completeness}% complete</p>
                        <p>Issues: ${project.issues_completed}/${project.issues_count}</p>
                        <p>Oral Rounds: ${project.oral_rounds_count}</p>
                        ${project.last_activity ? `<p>Last Activity: ${new Date(project.last_activity).toLocaleDateString()}</p>` : ''}
                    </div>

                    <div class="flex space-x-2">
                        <a href="/faculty-project.html?id=${project.project_id}" class="flex-1 bg-blue-600 text-white text-center py-2 rounded text-sm hover:bg-blue-700">
                            View Details
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Render Activity
        function renderActivity(activity) {
            const container = document.getElementById('activity-list');
            if (!activity || activity.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                return;
            }

            container.innerHTML = activity.slice(0, 10).map(log => `
                <div class="flex items-center py-3 border-b border-gray-100 last:border-0">
                    <div class="flex-1">
                        <p class="text-sm text-gray-800">
                            <span class="font-medium">${log.action_type}</span>
                            ${log.target_name ? `on ${log.target_name}` : ''}
                        </p>
                        <p class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // Helper Functions
        function getStatusClass(status) {
            switch(status) {
                case 'locked': return 'status-locked';
                case 'submitted': return 'status-submitted';
                default: return 'status-draft';
            }
        }

        function viewTeamProjects(teamId) {
            document.getElementById('status-filter').value = '';
            loadProjects();
            // Filter projects by team
            const filtered = projectsData.filter(p => p.team_id === teamId);
            renderProjects(filtered);
        }

        function showGuidelines() {
            document.getElementById('guidelines-modal').classList.remove('hidden');
        }

        function closeGuidelines() {
            document.getElementById('guidelines-modal').classList.add('hidden');
        }

        function showError(message) {
            alert(message); // Simple error display - can be enhanced
        }
    </script>
</body>
</html>
